<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>T·∫•t c·∫£ License Keys</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .exp-good { color: #4caf50; font-weight: bold; white-space: nowrap; }
    .exp-warning { color: #ffc400; font-weight: bold; white-space: nowrap; }
    .exp-expired { color: #ff5252; font-weight: bold; white-space: nowrap; }

    .status-pill {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-ok { background: #1ecf6d30; color: #1ecf6d; }
    .status-locked { background: #ff525230; color: #ff5252; }

    .table-wrap {
      overflow-x: auto;
      white-space: nowrap;
      border-radius: 12px;
      background: rgba(255,255,255,0.02);
      padding: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 950px;
    }

    table th {
      padding: 12px 14px;
      background: rgba(255,255,255,0.05);
      text-align: left;
      font-weight: bold;
      font-size: 14px;
      color: #d7d7d7;
    }

    table td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      font-size: 14px;
      white-space: nowrap;
    }

    tr:hover {
      background: rgba(255,255,255,0.06);
      transition: 0.15s;
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 6px;
      cursor: pointer;
      border: 0;
      margin-right: 5px;
    }

    .btn-copy { background: #1976d2; color: white; }
    .btn-copy:hover { background: #0d47a1; }

    .btn-delete { background: #d32f2f; color: white; }
    .btn-delete:hover { background: #9a0007; }
  </style>
</head>

<body>
  <div class="page-shell">
    <div class="card">

      <div class="flex-between">
        <div class="card-header" style="text-align:left;margin-bottom:16px;">
          <div class="badge">üîë Danh s√°ch key</div>
          <h1 class="card-title" style="font-size:1.5rem; font-weight:600;">T·∫•t c·∫£ License Key</h1>
          <p class="card-subtitle">
            Xem to√†n b·ªô key, tr·∫°ng th√°i, HWID, ghi ch√∫, ng√†y h·∫øt h·∫°n & l·ªãch s·ª≠.
          </p>
        </div>

        <button class="btn btn-ghost btn-sm" onclick="goBack()">‚Üê V·ªÅ menu</button>
      </div>

      <div class="table-wrap mt-3">
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Th·ªùi h·∫°n</th>
              <th>H·∫øt h·∫°n</th>
              <th>Ghi ch√∫</th>
              <th>HWID</th>
              <th>Tr·∫°ng th√°i</th>
              <th>L·ªãch s·ª≠</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="keysBody"></tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    function goBack() {
      window.location.href = "admin.html";
    }

    function copyKey(key) {
      navigator.clipboard.writeText(key);
      Swal.fire("ƒê√£ copy key!", key, "success");
    }

    async function deleteKey(key) {
      const confirm = await Swal.fire({
        title: "Xo√° Key?",
        text: key,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Xo√°",
        cancelButtonText: "H·ªßy",
      });

      if (!confirm.isConfirmed) return;

      const res = await fetch("https://checkkey-api.onrender.com/api/key/delete", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key })
      });

      const data = await res.json();

      if (data.success) {
        Swal.fire("ƒê√£ xo√°!", key, "success");
        loadAllKeys();
      } else {
        Swal.fire("L·ªói!", data.message, "error");
      }
    }

    /* ================================
       RENDER NG√ÄY + TIMELEFT
    ================================ */
    function renderExpire(vnTime, timeLeft) {
      if (!vnTime || vnTime === "Ch∆∞a k√≠ch ho·∫°t")
        return `<span class='exp-expired'>Ch∆∞a k√≠ch ho·∫°t</span>`;

      return `
        <div class="exp-good">${vnTime}</div>
        <div style="color:#9ecaff; font-size:12px; margin-top:2px">
          (C√≤n l·∫°i: ${timeLeft})
        </div>
      `;
    }

    /* ================================
       LOAD DANH S√ÅCH KEY
    ================================ */
    async function loadAllKeys(retry = 5) {
      try {
        const res = await fetch("https://checkkey-api.onrender.com/api/keys", { cache: "no-store" });
        if (!res.ok) throw new Error("Server not ready");

        const data = await res.json();
        const tbody = document.getElementById("keysBody");
        tbody.innerHTML = "";

        const db = data.data;

        Object.keys(db).forEach(key => {
          const item = db[key];

          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td><b>${key}</b></td>
            <td>${item.duration}</td>

            <td>${renderExpire(item.expireAtVN, item.timeLeft)}</td>

            <td>${item.note || ""}</td>
            <td>${item.hwid || "<i>Ch∆∞a bind</i>"}</td>

            <td><span class="status-pill ${item.locked ? "status-locked" : "status-ok"}">
                  ${item.locked ? "locked" : "ok"}
                </span>
            </td>

            <td>${item.history ? item.history.length : 0} l·∫ßn</td>

            <td>
              <button class="btn-icon btn-copy" onclick="copyKey('${key}')">üìã</button>
              <button class="btn-icon btn-delete" onclick="deleteKey('${key}')">üóë</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

      } catch (err) {
        if (retry > 0) {
          console.log("Server ƒëang ng·ªß ‚Üí th·ª≠ l·∫°i...", retry);
          setTimeout(() => loadAllKeys(retry - 1), 1500);
          return;
        }
        Swal.fire("L·ªói k·∫øt n·ªëi!", "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!", "error");
      }
    }

    loadAllKeys();
  </script>
</body>
</html>
