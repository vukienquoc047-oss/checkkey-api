<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>T·∫•t c·∫£ License Keys</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .exp-good { color: #00e676; font-weight: bold; }
    .exp-warning { color: #ffea00; font-weight: bold; }
    .exp-expired { color: #ff1744; font-weight: bold; }
  </style>
</head>

<body>
  <div class="page-shell">
    <div class="card">
      <div class="flex-between">
        <div class="card-header" style="text-align:left;margin-bottom:16px;">
          <div class="badge">üîë Danh s√°ch key</div>
          <h1 class="card-title" style="font-size:1.4rem;">T·∫•t c·∫£ License Key</h1>
          <p class="card-subtitle">
            Xem to√†n b·ªô key, tr·∫°ng th√°i, HWID, ghi ch√∫, ng√†y h·∫øt h·∫°n & l·ªãch s·ª≠.
          </p>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="goBack()">‚Üê V·ªÅ menu</button>
      </div>

      <div class="table-wrap mt-3">
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Th·ªùi h·∫°n</th>
              <th>H·∫øt h·∫°n</th>
              <th>Ghi ch√∫</th>
              <th>HWID</th>
              <th>Tr·∫°ng th√°i</th>
              <th>L·ªãch s·ª≠</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="keysBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function goBack() {
      window.location.href = "admin.html";
    }

    function copyKey(key) {
      navigator.clipboard.writeText(key);
      Swal.fire("ƒê√£ copy key!", key, "success");
    }

    async function deleteKey(key) {
      const confirm = await Swal.fire({
        title: "Xo√° Key?",
        text: key,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Xo√°",
        cancelButtonText: "H·ªßy",
      });

      if (!confirm.isConfirmed) return;

      const res = await fetch("https://checkkey-api.onrender.com/api/key/delete", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key })
      });

      const data = await res.json();

      if (data.success) {
        Swal.fire("ƒê√£ xo√°!", key, "success");
        loadAllKeys();
      } else {
        Swal.fire("L·ªói!", data.message, "error");
      }
    }

    // ========================
    // FORMAT expireAt + m√†u s·∫Øc
    // ========================
    function renderExpire(dateString) {
      if (!dateString) return "<span class='exp-expired'>Kh√¥ng c√≥</span>";

      const exp = new Date(dateString);
      const now = new Date();

      const diff = exp - now;
      const hours = diff / 1000 / 3600;

      if (hours <= 0) {
        return `<span class='exp-expired'>${dateString} (H·∫øt h·∫°n)</span>`;
      }
      if (hours <= 24) {
        return `<span class='exp-warning'>${dateString} (S·∫Øp h·∫øt h·∫°n)</span>`;
      }
      return `<span class='exp-good'>${dateString}</span>`;
    }

    // ========================
    // LOAD KEY + HI·ªÇN TH·ªä
    // ========================
    async function loadAllKeys(retry = 5) {
      try {
        const res = await fetch("https://checkkey-api.onrender.com/api/keys", { cache: "no-store" });
        if (!res.ok) throw new Error("Server not ready");

        const data = await res.json();
        const tbody = document.getElementById("keysBody");
        tbody.innerHTML = "";

        const db = data.data;

        Object.keys(db).forEach(key => {
          const item = db[key];
          const tr = document.createElement("tr");

          tr.innerHTML = `
            <td><b>${key}</b></td>
            <td>${item.duration}</td>
            <td>${renderExpire(item.expireAt)}</td>
            <td>${item.note || ""}</td>
            <td>${item.hwid || "Ch∆∞a bind"}</td>
            <td>
              <span class="status-pill ${item.locked ? "status-locked" : "status-ok"}">
                ${item.locked ? "locked" : "ok"}
              </span>
            </td>
            <td>${item.history ? item.history.length : 0} l·∫ßn</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="copyKey('${key}')">üìã</button>
              <button class="btn btn-sm btn-danger" onclick="deleteKey('${key}')">üóë</button>
            </td>
          `;

          tbody.appendChild(tr);
        });

      } catch (err) {
        if (retry > 0) {
          console.log("Server ƒëang ng·ªß ‚Üí th·ª≠ l·∫°i...", retry);
          setTimeout(() => loadAllKeys(retry - 1), 1500);
          return;
        }
        Swal.fire("L·ªói k·∫øt n·ªëi!", "Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c server!", "error");
      }
    }

    loadAllKeys();
  </script>
</body>
</html>
